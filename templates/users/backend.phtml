<?php
/*
 * Copyright (c) 2011, webvariants GbR, http://www.webvariants.de
 *
 * This file is released under the terms of the MIT license. You can find the
 * complete text in the attached LICENSE file or online at:
 *
 * http://www.opensource.org/licenses/mit-license.php
 */

if (!empty($errormsg)) {
	print rex_warning($errormsg);
}

$form = new sly_Form('index.php', 'POST', 'Benutzer '.($func == 'add' ? 'erstellen' : 'bearbeiten'), '', 'wv16_user');

$form->addHiddenValue('page', 'frontenduser');
$form->addHiddenValue('func', 'do_'.$func);
$form->addHiddenValue('id',   $user ? $user->getID() : '');

////////////////////////////////////////////////////////////////////////////////
// Normale Felder

$login     = new sly_Form_Input_Text('login', 'Login', $user ? $user->getLogin() : '');
$password1 = new sly_Form_Input_Password('password', 'Passwort', '');
$password2 = new sly_Form_Input_Password('password2', 'Passwort wiederholen', '');
$confirmed = new sly_Form_Input_Checkbox('confirmed', 'Bestätigt', 1, 'Dieses Benutzerkonto ist bestätigt.');
$activated = new sly_Form_Input_Checkbox('activated', 'Freigeschaltet', 1, 'Dieses Benutzerkonto ist freigeschaltet.');

$confirmed->setChecked($user && $user->isConfirmed());
$confirmed->setHelpText('Bestätigung bedeutet, dass der Benutzer sein Konto selbst validiert (z.B. über einen Link in einer E-Mail) hat.');

$activated->setChecked(!$user || $user->isActivated());
$activated->setHelpText('Nur hier freigeschaltete Benutzer können sich einloggen.');

$types       = WV16_Provider::getUserTypes();
$typesSelect = array();

foreach ($types as $name => $type) {
	$typesSelect[$name] = $type->getTitle();
}

$type = new sly_Form_Select_DropDown('type', 'Benutzertyp', $user ? $user->getTypeName() : _WV16_UserType::DEFAULT_NAME, $typesSelect);

$form->addElements(array($login, $password1, $password2, $activated, $confirmed, $type));

////////////////////////////////////////////////////////////////////////////////
// Attribute bearbeiten

$form->beginFieldset('Attribute für den aktuellen Benutzertyp', 'wv16attributes');

$userType      = $user ? $user->getTypeName() : _WV16_UserType::DEFAULT_NAME;
$requiredInfos = WV16_Provider::getAttributes($userType);
$assignedData  = $user ? $user->getValues(true) : array();
$dataToDisplay = $this->getAttributesToDisplay($assignedData, $requiredInfos);
$attributes    = $user ? $user->getType()->getAttributes() : $requiredInfos;
$attributeIDs  = array();

foreach ($attributes as $a) {
	$attributeIDs[] = $a->getID();
}

foreach ($dataToDisplay as $data) {
	$value      = !empty($data['data']) ? $data['data']->getSerializedValue() : null;
	$datatypeID = $data['attribute']->getDatatypeID();
	$hidden     = !in_array($data['attribute']->getID(), $attributeIDs);
	$parameters = array($form, $data['attribute'], array($value));
	$visible    = $data['attribute']->isVisible() ? '' : ' wv16_hidden_attribute';

	$style    = $hidden ? ' style="display:none"' : '';
	$fragment = new sly_Form_Fragment('<div id="wv16_attribute'.$data['attribute']->getID().'_row" class="wv16_attribute_row'.$visible.'"'.$style.'>');

	$form->add($fragment);
	WV_Datatype::call($datatypeID, 'renderForm', $parameters);
	$form->add(new sly_Form_Fragment('</div>'));
}

////////////////////////////////////////////////////////////////////////////////
// Zuordnung zu den Gruppen

$assignedGroups  = $user ? $user->getGroupNames() : array();
$availableGroups = WV16_Provider::getGroups();
$groups          = array();

foreach ($availableGroups as $index => $group) {
	$groups[$group->getID()] = $group->getTitle();
}

if (!empty($groups)) {
	$form->beginFieldset('Dieser Benutzer gehört den folgenden Gruppen an:');
	$groups = new sly_Form_Select_Checkbox('groups', 'Benutzergruppen', $assignedGroups, $groups);
	$form->add($groups);
}
else {
	$form->beginFieldset('Optionen');
}

////////////////////////////////////////////////////////////////////////////////
// Buttons festlegen

if ($user) {
	$delete = new sly_Form_Input_Button('submit', 'delete', 'Löschen');
	$delete->setAttribute('onclick', 'return confirm("Sicher, dass dieser Benutzer gelöscht werden soll?")');
	$form->setDeleteButton($delete);
}

////////////////////////////////////////////////////////////////////////////////
// Fertig!

$form->setFocus('login');
print $form->render();

?>

<script type="text/javascript">
wv16.attributesPerType = [];
<?php

// Arrays generieren, die die Informationen beinhalten, welche Metainfos in welchem Typ
// vorhanden sind.

foreach (WV16_Provider::getUserTypes() as $type) {
	print 'wv16.attributesPerType[\''.$type->getName().'\'] = [';

	$list = array();

	foreach ($type->getAttributes() as $attr) {
		if (!$attr->isVisible()) continue;
		$list[] = $attr->getID();
	}

	print implode(',', $list);
	print "];\n";
}

?>
</script>
