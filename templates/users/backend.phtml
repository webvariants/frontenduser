<?
if (!empty($errormsg)) {
	WV_redaxo::error($errormsg);
}

$form = new WV_Backend_Form('index.php', 'POST', 'Benutzer '.($func == 'add' ? 'erstellen' : 'bearbeiten'));

$form->addHiddenValue('page', 'frontenduser');
$form->addHiddenValue('func',  'do_'.$func);
$form->addHiddenValue('id',    $user ? $user->getID() : '');

////////////////////////////////////////////////////////////////////////////////
// Normale Felder

$login     = new WV_Form_Input_Text('login', 'Login', $user ? $user->getLogin() : '');
$password1 = new WV_Form_Input_Password('password', 'Passwort', '');
$password2 = new WV_Form_Input_Password('password2', 'Passwort wiederholen', '');

$types = WV16_Users::getAllUserTypes();
$typesSelect = array();

foreach ($types as $type) {
	$typesSelect[$type->getID()] = $type->getTitle();
}

$type = new WV_Form_Select('type', 'Benutzertyp', $user ? $user->getTypeID() : _WV16::DEFAULT_USER_TYPE, $typesSelect);
$type->setAttribute('onchange', 'wv2.changeArticleType(this)');
$type->setMultiple(false);

////////////////////////////////////////////////////////////////////////////////
// Block 1 fertig

$form->addElements(array($login, $password1, $password2, $type));

////////////////////////////////////////////////////////////////////////////////
// Attribute bearbeiten

$form->beginFieldset('Attribute für den aktuellen Benutzertyp');

$requiredInfos = WV16_Users::getAttributesForUserType($user ? $user->getTypeID() : _WV16::DEFAULT_USER_TYPE);
$assignedData  = $user ? $user->getAttributes() : array();
$dataToDisplay = _WV16::getAttributesToDisplay(WV16_Users::getAllAttributes(), $assignedData, $requiredInfos);
$attributes    = $user ? WV16_Users::getUserTypeAsObject($user)->getAttributes() : array();

foreach ($dataToDisplay as $data) {
	$value = !empty($data['data']) ? $data['data']->getValue() : null;
	WV_Datatype::call($data['info']->getDatatypeID(), 'renderAsFormElement', array($form, $value, !in_array($data['info']->getID(), $attributes), $data['info']));
}

////////////////////////////////////////////////////////////////////////////////
// Zuordnung zu den Gruppen

$form->beginFieldset('Dieser Benutzer gehört den folgenden Gruppen an:');

$assignedGroups  = $user ? $user->getGroupIDs() : array();
$availableGroups = WV16_Users::getAllGroups();
$groups          = array();

foreach ($availableGroups as $index => $group) {
	$groups[$group->getID()] = $group->getTitle();
}

$groups = new WV_Form_CheckboxGroup('groups', 'Benutzergruppen', $assignedGroups, $groups);
$groups->setAttribute('onchange', 'wv2.changeArticleType(this)');
$groups->setMultiple(false);

$form->add($groups);

////////////////////////////////////////////////////////////////////////////////
// Fertig!

$form->render();

?>

<script type="text/javascript">
/* <![CDATA[ */
wv2.infosPerType = [];
<?php
	
// Arrays generieren, die die Informationen beinhalten, welche Metainfos in welchem Typ
// vorhanden sind.

foreach (WV16_Users::getAllUserTypes() as $type) {
	print "\n";
	print 'wv2.infosPerType['.$type->getID().'] = [];';
	
	foreach ($type->getAttributeIDs() as $attr) {
		print "\n";
		print 'wv2.infosPerType['.$type->getID().'].push('.$attr.');';
	}
	
	print "\n";
}

?>
/* ]]> */
</script>
